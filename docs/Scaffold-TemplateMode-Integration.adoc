= Scaffold TemplateMode Integration
:toc: left
:icons: font
:source-highlighter: rouge

This document describes how the TemplateMode feature from StacksComponents is integrated into the scaffold functionality.

== Overview

The scaffold's `configurePipeline` function now checks the `TemplateMode` setting from the corresponding `StacksComponent` and only runs template-based variable file creation when TemplateMode is enabled (true).

== Implementation Details

=== Changes Made

. *Modified `configurePipeline` function* in `pkg/scaffold/scaffold.go`
   * Added logic to retrieve the StacksComponent using the framework key
   * Check if TemplateMode is enabled using the helper method
   * Only execute template variable file creation when TemplateMode is true

. *Key Mapping*
   * Uses the same key generation logic: `Framework.GetMapKey()` returns `{Type}_{Option}`
   * Maps to StacksComponent keys in the format `{Group}_{Name}`

=== Code Flow

[source,go]
----
// Get the StacksComponent to check if TemplateMode is enabled
key := project.Framework.GetMapKey()  // e.g., "dotnet_webapi"
component, exists := s.Config.Stacks.Components[key]

if !exists {
    s.Logger.Warnf("No StacksComponent found for framework key: %s", key)
} else if component.IsTemplateModeEnabled() {
    // Only run template-based variable file creation if TemplateMode is enabled
    s.Logger.Debugf("TemplateMode is enabled for component: %s", key)
    
    // Original commented code is now executed conditionally
    if s.Config.Input.Options.DryRun {
        s.Logger.Warn("Not creating variables template as in DRYRUN mode")
    } else {
        msg, err := s.Config.WriteVariablesFile(project, pipelineSettings, replacements)
        // ... handle result
    }
} else {
    s.Logger.Infof("TemplateMode is disabled for component: %s, skipping variable file creation", key)
}
----

== Behavior

=== When TemplateMode is enabled (true - default)

* The scaffold *WILL* execute the template-based variable file creation
* Logs: "TemplateMode is enabled for component: {key}"
* Logs: "Created pipeline variable file" (on success)

=== When TemplateMode is disabled (false)

* The scaffold *WILL NOT* execute the template-based variable file creation
* Logs: "TemplateMode is disabled for component: {key}, skipping variable file creation"

=== When StacksComponent is missing

* The scaffold *WILL NOT* execute the template-based variable file creation
* Logs: "No StacksComponent found for framework key: {key}"

=== All Cases

* The scaffold *ALWAYS* continues with file patching operations regardless of TemplateMode setting
* File patching (`pipelineSettings.ReplacePatterns()`) is executed after the TemplateMode check

== Configuration Examples

=== Default Behavior (TemplateMode enabled)

[source,yaml]
----
stacks:
  components:
    dotnet_webapi:
      group: dotnet
      name: webapi
      package:
        url: https://github.com/example/stacks-dotnet
        version: main
        type: git
      # templateMode not specified - defaults to true
----

=== Explicitly Disabled

[source,yaml]
----
stacks:
  components:
    dotnet_webapi:
      group: dotnet
      name: webapi
      package:
        url: https://github.com/example/stacks-dotnet
        version: main
        type: git
      templateMode: false
----

== Integration Points

=== StacksComponent -> Framework Mapping

The connection between StacksComponent and Framework is established through consistent key generation:

[cols="2,3"]
|===
| Element | Format

| *StacksComponent key* | `{Group}_{Name}` (e.g., "dotnet_webapi")
| *Framework key* | `{Type}_{Option}` (e.g., "dotnet_webapi")
| *Generated by* | `project.Framework.GetMapKey()`
|===

=== Configuration Loading

. Configuration files are loaded and merged
. `Config.SetDefaultValues()` is called (sets TemplateMode defaults)
. Scaffold processes projects and calls `configurePipeline`
. `configurePipeline` checks TemplateMode for conditional execution

== Logging

The integration includes comprehensive logging at appropriate levels:

[cols="1,3"]
|===
| Level | Message

| *Debug* | "TemplateMode is enabled for component: {key}"
| *Info* | Template creation success/skip messages
| *Warn* | Missing components, DryRun mode warnings
| *Error* | Template creation failures
|===

== Testing

The implementation has been tested to ensure:

[horizontal]
Build compilation:: ✅ succeeds
Default TemplateMode behavior:: ✅ (true)
Explicit TemplateMode false behavior:: ✅
Missing component handling:: ✅
Key mapping consistency:: ✅

== Migration Impact

=== Existing Configurations

* *No breaking changes*: Existing configurations without `templateMode` will default to `true`
* *Backward compatible*: All existing behavior is preserved by default

=== New Configurations

* Can explicitly set `templateMode: false` to skip variable file template creation
* Template creation is now conditional rather than always commented out

== Future Enhancements

Potential future improvements could include:

* Additional TemplateMode checks in other scaffold operations
* More granular template mode controls (per-pipeline, per-file, etc.)
* Template mode inheritance or cascading rules
