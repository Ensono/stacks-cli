== Testing

Testing is an integral part of building and running the Ensono Stacks CLI. There are many unit tests that are run before the CLI is compiled, and then once compilation has been completed a number of integration tests are performed.

The integration tests are built as a separate binary, for each supported platform, and run the CLI with a number of scenarios. All of the commands of the CLI are tested:

 - scaffold
 - interactive
 - version

The integration tests test that the version of the CLI that is being tested matches the version that was set in the test at compilation time. This means that the test *must* be run against the correct version of the CLI for all tests to pass.

IMPORTANT: Due to the way that the interactive command works, the integration tests for this are not performed when they are run on Windows. This is because there is an issue with the way in which the prompts are displayed in a Windows console. This is does not stop the interactive mode being used on Windows, but as the prompts (with the given answer) is repeated this causes issues with the test framework.

The following table details the integration tests that are performed.

.Integration tests
[cols="1,2,2",options="header"]
|===
| Suite | Test | Description
.4+| CLI Alert Tests | TestProjectAlreadyExists | Ensures that the CLI does not overwrite a project if that project directory already exists
| TestAppsNotFoundInPathVar | The CLI attempts to check that the framework tools can be found in the PATH environment variable.

This test changes the PATH var so that the `dotnet` and `git` commands cannot be located and checks that the CLI output honours this
| TestBadConfigFile | Writes out a malformed YAML file and checks that the CLI detects this and displays the appropriate error message
| TestIncorrectFrameworkOption | Checks that if the wrong option for the specified framework is given that the CLI will report this message and move onto the next project (if one has been specified)
| Interactive Suite | TestInteractiveMode | By using the an expect library the prompts that the CLI gives in interactive mode is tested.

The test also checks that a configuration file is generated.
.5+| Argument Suite | TestProjectDirExists | Checks that the project directory exists after the CLI has been run with options specified on the command line.
| TestCmdLogExists | Ensures that the `cmdlog.txt` has been generated by the CLI
| TestVariablesFileExists | Ensures that the Azure DevOps variables file has been generated and is in the correct location
| TestNamespace | Tests that the project folders for the project code have been set with the specified company name.

NOTE: This is not something that is done by the CLI itself as it calls out to the `dotnet` command, but as the CLI calls out to the command it is tested.
| TestNoGitRepo | As no remote URL for the GitRepository has been specified there should be no git repository created for the project.
.8+| Config File Suite | TestProject1/project_directory_exists | Checks that the project directory has been created for the project
| TestProject1/variable_template_exists | Checks that the Azure DevOps variables template exists
| TestProject1/git_repo | Ensures that the project has been configured as a Git repository
| TestProject1/git_remote_url | Checks that the configuration file for the git repo has got the correct remote URL set
| TestProject2/project_directory_exists | Checks that the project directory has been created for the project
| TestProject2/variable_template_exists | Checks that the Azure DevOps variables template exists
| TestProject2/git_repo_not_created | Checks that the project does not have a git repo configured
| TestCmdLogDoesNotExist | Checks that a `cmdlog.txt` file has not been created
| Version Suite | TestVersionNumber | Tests that the version of the CLI matches the version of the test being run
|===

All of tests are run as part of the build and the results are uploaded as artifacts. The following screenshot shows an example of the results being displayed in Azure DevOps.

.Test results
image::images/build_tests.png[]

=== Running the tests locally

All of the integration tests are run using Eirctl, which means that they can be run on a local workstation.

[source,bash]
----
task test:integration
----

Running this command will execute the integration tests and use the current directory for creating projects and files.

IMPORTANT: The integration tests are destructive in that the project directory contents will be removed during and after the tests. Do not run this in a directory with files that you wish to keep.
