= Filesystem Downloader Tests
:toc: left
:icons: font
:source-highlighter: rouge

This document describes the comprehensive test suite for the filesystem downloader component.

== Overview

The filesystem downloader test suite provides comprehensive coverage for the local filesystem copying functionality, ensuring reliable operation for local development and testing scenarios.

== Test Coverage

=== Constructor and Setup Tests

==== `TestNewFilesystemDownloader`
* Verifies proper initialization of the downloader struct
* Tests that Path and TempDir fields are set correctly
* Confirms logger is initially nil

==== `TestFilesystem_SetLogger`
* Tests the SetLogger method functionality
* Verifies logger is properly assigned to the struct

==== `TestFilesystem_PackageURL`
* Tests the PackageURL method returns the correct path
* Ensures interface compliance

=== Core Functionality Tests

==== `TestFilesystem_Get_Success`
* **Primary success scenario test**
* Creates a complex directory structure with nested files
* Verifies all files are copied correctly with preserved content
* Tests both absolute and relative file paths within source

==== `TestFilesystem_Get_SkipsGitDirectory`
* **Critical Git exclusion test**
* Creates `.git` directories at multiple levels
* Verifies `.git` directories and files are excluded from copying
* Ensures regular files are still copied correctly

==== `TestFilesystem_Get_EmptySourceDirectory`
* Tests behavior with empty source directories
* Verifies destination directory is created
* Confirms no errors occur with empty sources

=== Error Handling Tests

==== `TestFilesystem_Get_NonExistentSource`
* Tests error handling for non-existent source paths
* Verifies appropriate error is returned
* Confirms destination path is still returned for potential cleanup

=== Edge Case Tests

==== `TestFilesystem_Get_WithRelativePaths`
* Tests functionality with relative paths for both source and destination
* Changes working directory during test to verify relative path handling
* Verifies content preservation with relative paths

==== `TestFilesystem_Get_PreservesFilePermissions`
* Tests file permission preservation (Unix/Linux only)
* Automatically skips on Windows due to different permission model
* Creates executable files and verifies permissions are maintained

=== Interface Compliance Tests

==== `TestFilesystem_ImplementsDownloaderInterface`
* **Compile-time interface verification**
* Ensures the filesystem downloader correctly implements the Downloader interface
* Tests all required methods are present with correct signatures

=== Performance Tests

==== `BenchmarkFilesystem_Get`
* Performance benchmark for the Get method
* Creates 100 test files for realistic performance measurement
* Measures operation time for complete directory copying
* Results on test system: ~56ms per operation (100 files)

== Test Environment Features

=== Temporary Directory Management
* All tests use `t.TempDir()` for automatic cleanup
* No manual cleanup required
* Isolated test environments prevent interference

=== Cross-Platform Compatibility
* Tests designed to work on Windows, Linux, and macOS
* Platform-specific tests (like permissions) are automatically skipped where not applicable
* Uses `filepath.Join()` for proper path handling

=== Logging Suppression
* Tests suppress log output by setting log level to `FatalLevel`
* Prevents test output noise while maintaining error reporting capability

== Test Execution

=== Run All Tests
[source,bash]
----
cd pkg/downloaders
go test -v
----

=== Run Specific Test
[source,bash]
----
go test -run TestFilesystem_Get_Success -v
----

=== Run Benchmarks
[source,bash]
----
go test -bench=BenchmarkFilesystem_Get
----

=== Test Coverage Report
[source,bash]
----
go test -cover
----

== Test Scenarios Covered

[horizontal]
Normal Operation:: ✅ File and directory copying
Git Exclusion:: ✅ `.git` directory filtering  
Error Handling:: ✅ Non-existent sources
Edge Cases:: ✅ Empty directories, relative paths
Permissions:: ✅ File permission preservation (Unix)
Interface Compliance:: ✅ Downloader interface implementation
Performance:: ✅ Benchmark measurements

== Notable Test Design Decisions

=== Singleton Pattern Testing
The filesystem downloader uses a singleton pattern (`var filesystem = &Filesystem{}`). The tests work correctly with this pattern because each test creates a new instance through `NewFilesystemDownloader()`, which reassigns the values to the singleton.

=== Windows-Specific Considerations
* Permission tests are skipped on Windows due to different ACL model
* File path separators handled correctly through `filepath` package
* Temporary directory creation works across platforms

=== Comprehensive Git Filtering
The `.git` directory exclusion is thoroughly tested with multiple scenarios:
* Root-level `.git` directories
* Nested `.git` directories in subdirectories
* Multiple `.git` files and subdirectories
* Mixed content with both `.git` and regular files

== Future Test Enhancements

Potential additional test scenarios could include:
* Large file handling (gigabyte-scale files)
* Symbolic link handling
* Special file types (devices, named pipes) on Unix systems
* Unicode filename support
* Very deep directory structures
* Concurrent access scenarios
