= Git Downloader Tests
:toc: left
:icons: font
:source-highlighter: rouge

This document describes the comprehensive test suite for the Git downloader component.

== Overview

The Git downloader test suite provides extensive coverage for Git repository cloning functionality, ensuring reliable operation across various Git hosting platforms and authentication scenarios. The test suite covers constructor validation, interface compliance, URL format handling, version specifications, and token-based authentication.

== Test Coverage

=== Constructor and Setup Tests

==== `TestNewGitDownloader`
* Verifies proper initialization of the Git downloader struct
* Tests that URL, Version, FrameworkVersion, TempDir, and Token fields are set correctly
* Confirms logger is initially nil
* Validates singleton pattern behavior with correct field assignment

==== `TestGit_SetLogger`
* Tests the SetLogger method functionality
* Verifies logger is properly assigned to the private logger field
* Confirms integration with different logger configurations

==== `TestGit_PackageURL`
* Tests the PackageURL method returns the correct Git URL
* Ensures interface compliance for URL retrieval
* Validates that the returned URL matches the constructor input

=== Field Validation Tests

==== `TestGit_StructFields`
* **Comprehensive field assignment verification**
* Tests all constructor parameters are correctly assigned to struct fields
* Validates URL, Version, FrameworkVersion, TempDir, and Token field mapping
* Ensures data integrity throughout the initialization process

==== `TestGit_EmptyValues`
* Tests initialization with empty string values for all parameters
* Verifies the downloader handles empty inputs gracefully
* Confirms empty values are preserved rather than replaced with defaults

=== Singleton Pattern Tests

==== `TestGit_SingletonBehavior`
* **Critical singleton pattern validation**
* Creates multiple downloader instances and verifies they reference the same object
* Tests that subsequent constructor calls overwrite previous values
* Ensures the singleton pattern is correctly implemented and maintained

=== URL Format Validation Tests

==== `TestGit_URLValidation`
* **Multi-platform Git URL support testing**
* Covers various Git URL formats:
  - HTTPS URLs (`https://github.com/user/repo.git`)
  - HTTPS URLs without `.git` suffix
  - SSH URLs (`git@github.com:user/repo.git`) 
  - GitLab URLs (`https://gitlab.com/user/repo.git`)
  - Bitbucket URLs (`https://bitbucket.org/user/repo.git`)
  - Custom Git server URLs
* Verifies URL preservation and correct PackageURL return values

=== Version Format Tests

==== `TestGit_VersionFormats`
* **Comprehensive Git version reference testing**
* Supports multiple version specification formats:
  - Semantic versions (`v1.2.3`)
  - Branch names (`main`, `master`)
  - Feature branches (`feature/new-functionality`)
  - Short commit hashes (`abc123f`)
  - Full commit hashes (`abc123f456789012345678901234567890abcdef0`)
  - Tag names (`release-2023-11-15`)
* Ensures version strings are preserved exactly as provided

=== Authentication Token Tests

==== `TestGit_TokenHandling`
* **Multi-platform token authentication testing**
* Covers various token formats:
  - GitHub Personal Access Tokens (`ghp_*`)
  - GitHub Classic Tokens (40-character hex)
  - GitLab Tokens (`glpat-*`)
  - Custom token formats
  - Empty tokens (for public repositories)
* Verifies token preservation and secure handling

=== Interface Compliance Tests

==== `TestGit_ImplementsDownloaderInterface`
* **Compile-time interface verification**
* Ensures the Git downloader correctly implements the Downloader interface
* Tests all required methods are present with correct signatures:
  - `Get() (string, error)`
  - `PackageURL() string` 
  - `SetLogger(*logrus.Logger)`

=== Logger Integration Tests

==== `TestGit_LoggerIntegration`
* Tests integration with various logger configurations
* Validates different logger setups:
  - Standard logrus logger
  - Debug level logger
  - JSON formatter logger
* Ensures logger assignment and configuration persistence

=== Performance Tests

==== `BenchmarkNewGitDownloader`
* Performance benchmark for Git downloader constructor
* Measures initialization time for singleton pattern
* Results on test system: ~2.034 ns per operation
* Validates efficient object creation and field assignment

== Mock Integration Documentation

=== Git Clone Operation Mocking

==== `TestGit_Get_IntegrationNote`
* **Comprehensive documentation for Get() method testing**
* Provides detailed guidance for mocking `util.GitClone` function
* Documents required test scenarios:
  - Successful clone of public repositories
  - Authentication-based cloning with tokens
  - Branch/tag/commit-specific cloning
  - Network failure handling
  - Invalid URL error handling
  - Repository not found (404) scenarios
  - Authentication failure handling
  - Disk space and permission issues

=== Mock Implementation Strategy
The tests include infrastructure for mocking external dependencies:

[source,go]
----
// MockGitClone function variable for test overrides
var mockGitClone func(string, string, string, string, string) (string, error)

// Original function storage for restoration
var gitCloneOriginal func(string, string, string, string, string) (string, error)
----

== Test Environment Features

=== Singleton Pattern Management
* All tests work correctly with the singleton pattern (`var git = &Git{}`)
* Each test creates a new logical instance through `NewGitDownloader()`
* Singleton state is properly managed and isolated between tests

=== Cross-Platform URL Support
* Tests designed to work with various Git hosting platforms
* Handles both SSH and HTTPS authentication methods
* Supports custom Git server configurations

=== Token Security Testing
* Tests various authentication token formats without exposing actual credentials
* Verifies token preservation throughout the downloader lifecycle
* Ensures tokens are handled securely in the struct

== Test Execution

=== Run All Git Tests
[source,bash]
----
cd pkg/downloaders
go test -run TestGit -v
----

=== Run Specific Test Categories
[source,bash]
----
# URL validation tests
go test -run TestGit_URLValidation -v

# Token handling tests  
go test -run TestGit_TokenHandling -v

# Version format tests
go test -run TestGit_VersionFormats -v
----

=== Run Benchmarks
[source,bash]
----
go test -bench=BenchmarkNewGitDownloader
----

=== Test Coverage Report
[source,bash]
----
go test -cover ./pkg/downloaders
----

== Test Scenarios Covered

[horizontal]
Constructor Validation:: ✅ Field assignment and initialization
URL Format Support:: ✅ HTTPS, SSH, and custom Git servers
Version Specifications:: ✅ Tags, branches, commits, semantic versions
Authentication:: ✅ GitHub, GitLab, and custom tokens
Interface Compliance:: ✅ Downloader interface implementation
Singleton Pattern:: ✅ Correct singleton behavior validation
Logger Integration:: ✅ Multiple logger configurations
Performance:: ✅ Constructor benchmark measurements
Edge Cases:: ✅ Empty values, invalid inputs

== Notable Test Design Decisions

=== Authentication Token Testing
The test suite validates various token formats without requiring actual authentication:
* Focuses on token preservation and handling rather than authentication validation
* Tests empty token scenarios for public repository access
* Validates token format recognition for different Git platforms

=== Version Reference Flexibility
Git supports multiple ways to reference code versions:
* **Tags**: Release versions (`v1.2.3`, `release-2023-11-15`)
* **Branches**: Development branches (`main`, `feature/new-feature`)
* **Commits**: Specific commit hashes (short and full SHA)
* Tests ensure all formats are preserved and handled correctly

=== Singleton Pattern Validation
The Git downloader uses a singleton pattern for memory efficiency:
* Tests verify that multiple constructor calls return the same instance
* Validates that the last constructor call's values are preserved
* Ensures thread-safe behavior in test scenarios

=== URL Format Comprehensive Coverage
Tests cover the major Git URL formats used in enterprise environments:
* **GitHub**: Public and private repositories
* **GitLab**: Both gitlab.com and self-hosted instances
* **Bitbucket**: Atlassian-hosted repositories
* **Custom servers**: Enterprise Git installations
* **SSH vs HTTPS**: Both authentication methods

== Integration Testing Recommendations

For comprehensive testing of the `Get()` method, implement the following mock strategies:

=== Mock `util.GitClone` Function
[source,go]
----
func mockGitCloneSuccess(url, version, framework, tempdir, token string) (string, error) {
    return "/tmp/mocked/clone/path", nil
}

func mockGitCloneFailure(url, version, framework, tempdir, token string) (string, error) {
    return "", errors.New("network connection failed")
}
----

=== Test Scenarios to Implement
* **Network failures**: Simulate connection timeouts and DNS failures
* **Authentication failures**: Test invalid tokens and permission denials
* **Repository not found**: Handle 404 errors gracefully
* **Invalid Git URLs**: Test malformed URL handling
* **Disk space issues**: Simulate insufficient storage scenarios
* **Git command failures**: Handle git binary errors

=== Integration Test Structure
[source,go]
----
func TestGit_Get_NetworkFailure(t *testing.T) {
    // Replace util.GitClone with mock that simulates network failure
    // Call downloader.Get()
    // Verify appropriate error handling and return values
}
----

== Future Test Enhancements

Potential additional test scenarios could include:
* **Large repository cloning**: Test with repositories containing gigabytes of data
* **Sparse checkout support**: Test partial repository cloning
* **Git LFS handling**: Large file support validation
* **Concurrent cloning**: Multiple simultaneous clone operations
* **Git hooks interaction**: Pre/post clone hook execution
* **Shallow clone support**: Limited history cloning
* **Submodule handling**: Recursive submodule cloning
* **Branch switching**: Post-clone branch checkout validation
