= NuGet Downloader Tests
:toc: left
:icons: font
:source-highlighter: rouge

This document describes the comprehensive test suite for the NuGet downloader component.

== Overview

The NuGet downloader test suite provides extensive coverage for NuGet package downloading and caching functionality, ensuring reliable operation across various NuGet feeds and .NET framework versions. The test suite covers constructor validation, interface compliance, version resolution (including "latest"), caching mechanisms, and integration with multiple NuGet feed types.

== Test Coverage

=== Constructor and Setup Tests

==== `TestNewNugetDownloader`
* Verifies proper initialization of the NuGet downloader struct
* Tests that Name, ID, Version, CacheDir, and TempDir fields are set correctly
* Confirms logger is initially nil
* Validates the complete 5-parameter constructor signature

==== `TestNewNugetDownloader_LatestVersion`
* **Special handling for "latest" version resolution**
* Tests initialization with "latest" version string
* Verifies that "latest" is preserved in the Version field
* Documents the internal latest flag behavior (private field testing limitation)

==== `TestNuget_SetLogger`
* Tests the SetLogger method functionality
* Verifies logger is properly assigned to the private logger field
* Confirms integration with different logger configurations

==== `TestNuget_PackageURL`
* Tests the PackageURL method returns the internal URL
* Initially returns empty string until setURL is called during Get() execution
* Ensures interface compliance for URL retrieval

=== Field Validation Tests

==== `TestNuget_StructFields`
* **Comprehensive field assignment verification**
* Tests all constructor parameters are correctly assigned to struct fields
* Validates Name, ID, Version, CacheDir, and TempDir field mapping
* Ensures data integrity throughout the initialization process

==== `TestNuget_EmptyValues`
* Tests initialization with empty string values for all parameters
* Verifies the downloader handles empty inputs gracefully
* Confirms empty values are preserved rather than replaced with defaults

=== Singleton Pattern Tests

==== `TestNuget_SingletonBehavior`
* **Critical singleton pattern validation**
* Creates multiple downloader instances and verifies they reference the same object
* Tests that subsequent constructor calls overwrite previous values
* Ensures the singleton pattern is correctly implemented and maintained

=== NuGet Feed URL Tests

==== `TestNuget_URLFormats`
* **Multi-platform NuGet feed support testing**
* Covers various NuGet feed URL formats:
  - NuGet.org official API URLs
  - Azure DevOps package feeds
  - JFrog Artifactory NuGet feeds
  - MyGet private feeds
  - Custom/self-hosted NuGet servers
* Documents internal URL construction vs external URL input

=== Version Format Tests

==== `TestNuget_VersionFormats`
* **Comprehensive NuGet version specification testing**
* Supports multiple version formats:
  - Semantic versions (`1.2.3`)
  - Pre-release versions (`1.2.3-alpha`)
  - Build metadata versions (`1.2.3-alpha.1+build.123`)
  - "Latest" version resolution
  - Version ranges (`[1.0.0,2.0.0)`) - documentation only
  - Four-part versions (`1.2.3.4`)
* Ensures version strings are preserved exactly as provided

=== .NET Framework Version Tests

==== `TestNuget_FrameworkVersions`
* **.NET target framework compatibility testing**
* Documents various .NET framework versions:
  - .NET 6.0, 7.0, 8.0 (`net6.0`, `net7.0`, `net8.0`)
  - .NET Standard 2.0, 2.1 (`netstandard2.0`, `netstandard2.1`)
  - .NET Framework 4.8 (`net48`)
  - .NET Core 3.1 (`netcoreapp3.1`)
  - Latest framework version
* Note: Framework version is not stored in the actual implementation

=== Directory Handling Tests

==== `TestNuget_TempDirectoryHandling`
* **Cross-platform directory path testing**
* Validates various temp directory scenarios:
  - Unix absolute paths (`/tmp/nuget-test`)
  - Windows absolute paths (`C:\temp\nuget-test`)
  - Relative paths (`./temp`)
  - Nested directory structures
  - Empty path handling
* Ensures proper path preservation across platforms

=== Interface Compliance Tests

==== `TestNuget_ImplementsDownloaderInterface`
* **Compile-time interface verification**
* Ensures the NuGet downloader correctly implements the Downloader interface
* Tests all required methods are present with correct signatures:
  - `Get() (string, error)`
  - `PackageURL() string`
  - `SetLogger(*logrus.Logger)`

=== Logger Integration Tests

==== `TestNuget_LoggerIntegration`
* Tests integration with various logger configurations
* Validates different logger setups:
  - Standard logrus logger
  - Info level logger
  - Text formatter logger
* Ensures logger assignment and configuration persistence

=== API Call Integration Tests

==== `TestNuget_APICallInitialization`
* Documents the internal APICall creation pattern
* Notes that APICall is instantiated within the Get() method
* Provides guidance for mocking models.NewAPICall in integration tests

=== Performance Tests

==== `BenchmarkNewNugetDownloader`
* Performance benchmark for NuGet downloader constructor
* Measures initialization time for singleton pattern
* Results on test system: ~5.967 ns per operation
* Validates efficient object creation and field assignment

== Mock Integration Documentation

=== NuGet API Operation Mocking

==== `TestNuget_Get_IntegrationNote`
* **Comprehensive documentation for Get() method testing**
* Provides detailed guidance for mocking multiple dependencies:
  - `models.APICall.Do()` for HTTP operations
  - `util.Exists()` for file system checks
  - `util.Unzip()` for package extraction
* Documents required test scenarios:
  - Successful download of specific versions
  - "Latest" version resolution workflow
  - Package cache hit scenarios (skip download)
  - API failures (network errors, 404s, timeouts)
  - Package extraction failures
  - Invalid version response handling

==== `TestNuget_GetLatestVersion_IntegrationNote`
* **Version resolution API testing documentation**
* Covers the private `getLatestVersion()` method behavior:
  - HTTP API calls to NuGet version endpoints
  - JSON response parsing for version lists
  - Version field updates after resolution
  - Error handling for malformed responses
* Provides mock implementation strategies

=== Mock Implementation Strategy
The tests include infrastructure for mocking external dependencies:

[source,go]
----
// MockAPICall for HTTP operations
type MockAPICall struct {
    mock.Mock
}

func (m *MockAPICall) Do() (*http.Response, error) {
    args := m.Called()
    if args.Get(0) == nil {
        return nil, args.Error(1)
    }
    return args.Get(0).(*http.Response), args.Error(1)
}

// Mock functions for utility operations
var mockExists func(string) bool
var mockUnzip func(string, string) error
----

== Test Environment Features

=== Singleton Pattern Management
* All tests work correctly with the singleton pattern (`var nuget = &Nuget{}`)
* Each test creates a new logical instance through `NewNugetDownloader()`
* Singleton state is properly managed and isolated between tests

=== NuGet Package Caching Logic
* Tests validate the caching behavior design
* Documents cache directory structure and file naming
* Ensures cache hit detection prevents redundant downloads

=== Multi-Feed Support Testing
* Tests designed to work with various NuGet feed configurations
* Handles both public (NuGet.org) and private feed scenarios
* Supports authentication-required feeds (documented for integration tests)

== Test Execution

=== Run All NuGet Tests
[source,bash]
----
cd pkg/downloaders
go test -run TestNuget -v
----

=== Run Specific Test Categories
[source,bash]
----
# Version format tests
go test -run TestNuget_VersionFormats -v

# URL format tests
go test -run TestNuget_URLFormats -v

# Framework version tests
go test -run TestNuget_FrameworkVersions -v

# Directory handling tests
go test -run TestNuget_TempDirectoryHandling -v
----

=== Run Benchmarks
[source,bash]
----
go test -bench=BenchmarkNewNugetDownloader
----

=== Test Coverage Report
[source,bash]
----
go test -cover ./pkg/downloaders
----

== Test Scenarios Covered

[horizontal]
Constructor Validation:: ✅ Field assignment and initialization
Package Identification:: ✅ Name, ID, and version handling
Version Resolution:: ✅ Semantic versions, latest, pre-release
Feed Support:: ✅ NuGet.org, Azure DevOps, Artifactory, custom
Framework Targeting:: ✅ .NET versions documentation
Directory Management:: ✅ Cache and temp directory handling
Interface Compliance:: ✅ Downloader interface implementation
Singleton Pattern:: ✅ Correct singleton behavior validation
Logger Integration:: ✅ Multiple logger configurations
Performance:: ✅ Constructor benchmark measurements
Edge Cases:: ✅ Empty values, invalid inputs

== Notable Test Design Decisions

=== NuGet Package Identification
NuGet packages require both a Name and ID for proper identification:
* **Name**: The display name used in API URLs and cache paths
* **ID**: The unique package identifier for template resolution
* Tests verify both fields are preserved and used correctly

=== Version Resolution Strategy
The NuGet downloader implements sophisticated version resolution:
* **Specific versions**: Direct download without API lookup
* **"Latest" versions**: API call to resolve to specific version number
* **Version caching**: Resolved versions update the downloader state
* Tests document this behavior for proper integration testing

=== Caching Mechanism Validation
The downloader implements intelligent caching to avoid redundant downloads:
* **Cache hit detection**: Uses `util.Exists()` to check for downloaded packages
* **Cache directory structure**: Organized by package name and version
* **Cache path construction**: Deterministic naming for cache files
* Tests provide framework for validating caching behavior

=== Multi-Feed Architecture
NuGet supports various package feed types in enterprise environments:
* **NuGet.org**: Public package repository
* **Azure DevOps**: Enterprise package feeds with authentication
* **Artifactory**: JFrog package management platform
* **MyGet**: Hosted private feeds
* **Custom servers**: Self-hosted NuGet server instances

=== URL Construction vs Input
Unlike other downloaders, the NuGet downloader constructs URLs internally:
* **Constructor input**: Package name and metadata
* **Internal URL generation**: Built during Get() method execution
* **Dynamic URLs**: Different URLs for version resolution vs package download
* Tests reflect this architectural difference

== Integration Testing Recommendations

For comprehensive testing of the `Get()` method, implement the following mock strategies:

=== Mock `models.APICall` Interface
[source,go]
----
type MockAPICall struct {
    responses map[string]*http.Response
    errors    map[string]error
}

func (m *MockAPICall) Do(method string) (error, int) {
    // Return mocked responses based on the configured URL
    return m.errors[m.url], 200
}
----

=== Mock `util.Exists` Function
[source,go]
----
var mockExistsResponses = make(map[string]bool)

func mockExists(path string) bool {
    return mockExistsResponses[path]
}
----

=== Mock `util.Unzip` Function
[source,go]
----
var mockUnzipResponses = make(map[string]error)

func mockUnzip(src, dest string) error {
    return mockUnzipResponses[src]
}
----

=== Test Scenarios to Implement

==== Cache Behavior Testing
[source,go]
----
func TestNuget_Get_CacheHit(t *testing.T) {
    // Mock util.Exists to return true for package file
    // Call downloader.Get()
    // Verify no API calls were made
    // Verify package path is returned correctly
}
----

==== Version Resolution Testing
[source,go]
----
func TestNuget_Get_LatestVersionResolution(t *testing.T) {
    // Mock API response with version list
    // Call downloader.Get() with version="latest"
    // Verify API was called for version resolution
    // Verify downloader.Version was updated with resolved version
}
----

==== Error Scenario Testing
* **Network failures**: Simulate API connection timeouts
* **Package not found**: Test 404 responses from NuGet feeds
* **Malformed packages**: Test corrupted ZIP file handling
* **Permission errors**: Simulate cache directory write failures
* **Disk space issues**: Test insufficient storage scenarios

=== Integration Test Structure
[source,go]
----
func TestNuget_Get_APIFailure(t *testing.T) {
    // Setup mock API to return error
    // Call downloader.Get()
    // Verify appropriate error handling and return values
    // Verify no partial state corruption
}
----

== Package URL Construction

The NuGet downloader constructs URLs dynamically based on the package name and version:

=== Version-Specific URLs
[source]
----
https://api.nuget.org/v3/registration5-semver1/{packagename}/{version}.json
----

=== Latest Version URLs
[source]
----
https://api.nuget.org/v3/registration5-semver1/{packagename}/index.json
https://api.nuget.org/v3-flatcontainer/{packagename}/index.json
----

=== Package Download URLs
[source]
----
https://api.nuget.org/v3-flatcontainer/{packagename}/{version}/{packagename}.{version}.nupkg
----

== Cache Directory Structure

The NuGet downloader organizes cached packages in a predictable structure:

[source]
----
{CacheDir}/
├── package1.1.0.0.nupkg
├── package2.2.1.0.nupkg
└── package3.3.0.0-alpha.nupkg
----

== Future Test Enhancements

Potential additional test scenarios could include:
* **Authentication testing**: Private feed authentication with API keys
* **Package signature validation**: NuGet package signing verification
* **Package vulnerability scanning**: Security validation integration
* **Large package handling**: Multi-gigabyte package downloads
* **Concurrent downloads**: Multiple simultaneous package operations
* **Package dependency resolution**: Transitive dependency handling
* **Package source priority**: Multiple feed preference testing
* **Package restoration**: MSBuild integration scenarios
* **Symbol package handling**: Debug symbol package management
* **Package license compliance**: License validation workflows
